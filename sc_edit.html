<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SC 구조 검사기 · 로컬 HTML</title>
  <style>
    :root {
      --bg: #0f172a; --panel: #111827; --muted: #334155; --text: #e5e7eb;
      --accent: #22d3ee; --warn: #f59e0b; --err: #ef4444; --ok: #10b981; --chip: #1f2937;
    }
    * { box-sizing: border-box }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1220, #0a0f1a 40%, #0b1220);
      color: var(--text);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, sans-serif;
    }
    .wrap { max-width: 1100px; margin: 32px auto; padding: 0 16px; }
    header { display:flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    header h1 { font-size: 22px; margin: 0; letter-spacing: 0.2px; }
    header .chip { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: var(--chip); color:#cbd5e1; }

    .card { background: rgba(17,24,39,0.9); border: 1px solid #1f2937; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .card .head { padding: 14px 16px; border-bottom: 1px solid #1f2937; display:flex; justify-content: space-between; align-items:center; gap:12px; }
    .card .head h2 { margin: 0; font-size: 16px; color:#e2e8f0; }
    .card .body { padding: 16px; }
    .row { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
    @media (max-width: 980px){ .row { grid-template-columns: 1fr; } }

    .drop { border: 2px dashed #334155; border-radius: 12px; padding: 18px; text-align: center; background: rgba(2,6,23,0.35); transition: border-color .2s, background .2s; cursor: pointer; }
    .drop:hover { border-color: var(--accent); }
    .drop.dragover { border-color: var(--accent); background: rgba(34,211,238,0.06); }
    .hint { color:#94a3b8; font-size: 13px; }

    .controls { display:flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 12px; }
    .btn { appearance: none; border: 1px solid #334155; background: #0b1220; color: #e5e7eb; padding: 10px 14px; border-radius: 10px; cursor: pointer; transition: transform .02s ease, background .2s, border-color .2s; }
    .btn:hover { border-color: var(--accent); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(180deg, #0ea5b7, #0891b2); border-color: #0891b2; }
    .btn.primary:hover { background: linear-gradient(180deg, #22d3ee, #06b6d4); }

    .summary { display:flex; gap: 12px; flex-wrap: wrap; }
    .badge { background: #111827; border:1px solid #1f2937; border-radius: 10px; padding: 6px 10px; font-size: 13px; }
    .badge.ok { border-color: #064e3b; color:#a7f3d0; }
    .badge.warn { border-color: #7c2d12; color:#fed7aa; }

    .table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .table th, .table td { border-bottom: 1px solid #1f2937; padding: 8px 10px; vertical-align: top; }
    .table th { text-align: left; color:#cbd5e1; font-weight: 600; }
    .table tr:hover td { background: rgba(148,163,184,0.05); }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#e5e7eb; }

    .viewer { background: #0b1220; border:1px solid #1f2937; border-radius: 10px; padding: 0; overflow: hidden; height: 380px; display:flex; }
    .gutter { width: 80px; background: #0a0f1a; color:#64748b; border-right: 1px solid #1f2937; overflow:auto; }
    .lines { flex:1; overflow:auto; }
    .gutter div, .lines pre { margin: 0; padding: 2px 10px; white-space: pre; }
    .hit { background: rgba(239,68,68,0.1); }
    .hit-ja { background: rgba(245,158,11,0.1); }
    .sticky { position: sticky; top: 0; background: #0a0f1a; z-index: 1; padding: 8px 10px; border-bottom: 1px solid #1f2937; }

    .footer { margin-top: 18px; color:#94a3b8; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SC 구조 검사기</h1>
      <span class="chip">로컬 실행</span>
    </header>

    <div class="card" id="uploader">
      <div class="head"><h2>파일 업로드</h2></div>
      <div class="body">
        <label class="drop" id="drop">
          <input type="file" id="file" accept=".sc,.txt,.json,.cfg,.ini,.csv,.xml,.yml,.yaml,.md,.log" hidden />
          <div style="font-size:15px; margin-bottom:6px;">여기에 파일을 끌어놓으시거나 클릭하여 선택하십시오 (.SC 권장)</div>
          <div class="hint">대용량 파일도 가능합니다. 로컬에서만 처리합니다.</div>
        </label>
        <div class="controls">
          <button class="btn" id="choose">파일 선택</button>
          <button class="btn primary" id="analyze">서치</button>
          <input type="text" id="fname" placeholder="파일명 (예: result.sc)" style="min-width:220px;padding:9px 10px;border:1px solid #334155;border-radius:10px;background:#0b1220;color:#e5e7eb;" />
          <button class="btn" id="download" disabled>파일 다운로드</button>
          <span id="fileInfo" class="hint"></span>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <div class="card">
        <div class="head"><h2>결과 요약</h2></div>
        <div class="body">
          <div class="summary">
            <div class="badge" id="totalLines">총 줄: -</div>
            <div class="badge warn" id="oddQuotes">따옴표 문제 줄: -</div>
            <div class="badge warn" id="jpLines">일본어 포함 줄: -</div>
            <div class="badge ok" id="okMsg" style="display:none;">문제 없음</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="head"><h2>옵션</h2></div>
        <div class="body">
          <label style="display:block; margin-bottom:8px;">
            <input type="checkbox" id="ignoreEscaped" checked /> 역슬래시(\\)로 이스케이프된 따옴표는 제외
          </label>
          <label style="display:block;">
            <input type="checkbox" id="kanjiToo" checked /> 한자(統一表意文字)도 일본어로 간주
          </label>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="head"><h2>원본 미리보기</h2></div>
      <div class="body">
        <div class="viewer" id="viewer" aria-live="polite">
          <div class="gutter" id="gutter"></div>
          <div class="lines" id="lines"></div>
        </div>
        <div class="footer">문제 줄은 붉은색 배경(따옴표), 주황색 배경(일본어)으로 표시됩니다.</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="head"><h2>세부 목록</h2></div>
      <div class="body">
        <h3 style="margin:0 0 6px 0; font-size:15px;">따옴표 문제 (짝수 아님 또는 1개만 존재)</h3>
        <table class="table" id="tblQuotes">
          <thead><tr><th style="width:100px">줄 번호</th><th>내용</th></tr></thead>
          <tbody></tbody>
        </table>
        <div style="height:10px"></div>
        <h3 style="margin:0 0 6px 0; font-size:15px;">일본어 포함</h3>
        <table class="table" id="tblJP">
          <thead><tr><th style="width:100px">줄 번호</th><th>내용</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // 유틸: 안전한 텍스트 출력
    function esc(s) {
      return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    }

    function countUnescapedQuotes(line, ignoreEscaped=true) {
      if (!ignoreEscaped) {
        return (line.match(/"/g) || []).length;
      }
      // 이스케이프되지 않은 따옴표만 카운트
      let c = 0;
      for (let i=0;i<line.length;i++) {
        if (line[i] === '"') {
          const prev = line[i-1];
          if (prev !== '\\') c++;
        }
      }
      return c;
    }

    function quoteCount(line, ignoreEscaped) {
      if (ignoreEscaped) return countUnescapedQuotes(line, true);
      // 이스케이프 포함 전체 따옴표 개수
      return (line.match(/"/g) || []).length;
    }

    function hasJapanese(line, includeKanji=true) {
      // 구두점/괄호 제외. 히라가나/가타카나(전각/반각)만 기본 탐지
      const kana = /[\u3041-\u3096\u30A1-\u30FA\uFF66-\uFF9D]/;
      const kanji = /[\u4E00-\u9FFF]/; // CJK Unified Ideographs
      return includeKanji ? (kana.test(line) || kanji.test(line)) : kana.test(line);
    }

    const fileEl = document.getElementById('file');
    const dropEl = document.getElementById('drop');
    const chooseBtn = document.getElementById('choose');
    const analyzeBtn = document.getElementById('analyze');
    const downloadBtn = document.getElementById('download');
    const fnameInput = document.getElementById('fname');
    const fileInfo = document.getElementById('fileInfo');

    const totalLines = document.getElementById('totalLines');
    const oddQuotes = document.getElementById('oddQuotes');
    const jpLines = document.getElementById('jpLines');
    const okMsg = document.getElementById('okMsg');

    const gutter = document.getElementById('gutter');
    const linesDiv = document.getElementById('lines');

    const tblQuotes = document.querySelector('#tblQuotes tbody');
    const tblJP = document.querySelector('#tblJP tbody');

    const ignoreEscaped = document.getElementById('ignoreEscaped');
    const kanjiToo = document.getElementById('kanjiToo');

    let rawText = '';
    let lines = [];
    let currentFilename = 'edited.sc';
    let dirty = false;

    function setFileInfo(f) {
      if (!f) { fileInfo.textContent = ''; downloadBtn.disabled = true; return; }
      const kb = (f.size/1024).toFixed(1);
      fileInfo.textContent = `${f.name} · ${kb} KB`;
      currentFilename = (f.name || 'edited.sc').replace(/(\.[^.]+)?$/, '.edited.sc');
      if (fnameInput) fnameInput.value = currentFilename;
      downloadBtn.disabled = false;
    }

    chooseBtn.addEventListener('click', () => fileEl.click());
    dropEl.addEventListener('click', () => fileEl.click());
    ;['dragover','dragenter'].forEach(ev => dropEl.addEventListener(ev, e=>{ e.preventDefault(); dropEl.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(ev => dropEl.addEventListener(ev, e=>{ dropEl.classList.remove('dragover'); }));
    dropEl.addEventListener('drop', e => {
      e.preventDefault();
      const f = e.dataTransfer.files?.[0];
      if (f) { fileEl.files = e.dataTransfer.files; setFileInfo(f); readFile(f); }
    });

    fileEl.addEventListener('change', () => {
      const f = fileEl.files?.[0];
      if (f) { setFileInfo(f); readFile(f); }
    });

    function readFile(f){
      const reader = new FileReader();
      reader.onload = () => {
        rawText = String(reader.result || '');
        lines = rawText.replace(/\r\n?/g, '\n').split('\n');
        renderPreview();
        resetResults();
      };
      reader.readAsText(f, 'utf-8');
    }

    function resetResults(){
      totalLines.textContent = `총 줄: ${lines.length}`;
      oddQuotes.textContent = `따옴표 문제 줄: -`;
      jpLines.textContent = `일본어 포함 줄: -`;
      okMsg.style.display = 'none';
      tblQuotes.innerHTML = '';
      tblJP.innerHTML = '';
      Array.from(gutter.children).forEach(el=>{ el.classList.remove('hit','hit-ja'); });
      Array.from(linesDiv.querySelectorAll('pre')).forEach(el=>{ el.classList.remove('hit','hit-ja'); });
    }

    function renderPreview(){
      gutter.innerHTML = '';
      linesDiv.innerHTML = '';
      const gutFrag = document.createDocumentFragment();
      const lineFrag = document.createDocumentFragment();
      const gHead = document.createElement('div'); gHead.className='sticky'; gHead.textContent = '#'; gutFrag.appendChild(gHead);
      const lHead = document.createElement('div'); lHead.className='sticky'; lHead.innerHTML = '<strong>내용 — 더블클릭하여 수정</strong>'; lineFrag.appendChild(lHead);
      for (let i=0;i<lines.length;i++){
        const g = document.createElement('div'); g.textContent = (i+1).toString(); gutFrag.appendChild(g);
        const p = document.createElement('pre'); p.className='code'; p.dataset.index = String(i); p.textContent = lines[i]; lineFrag.appendChild(p);
      }
      gutter.appendChild(gutFrag);
      linesDiv.appendChild(lineFrag);
    }

    function addRow(tbody, idx, text){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.innerHTML = `<a href="#" data-line="${idx}" class="jump">${idx}</a>`; tr.appendChild(td1);
      const td2 = document.createElement('td'); td2.innerHTML = `<span class="code">${esc(text)}</span>`; tr.appendChild(td2);
      tbody.appendChild(tr);
    }

    function jumpToLine(idx){
      const lineEl = linesDiv.querySelectorAll('pre')[idx-1];
      const gutEl = gutter.children[idx];
      if (!lineEl || !gutEl) return;
      lineEl.scrollIntoView({behavior:'smooth', block:'center'});
      lineEl.classList.add('hit'); gutEl.classList.add('hit');
      setTimeout(()=>{ lineEl.classList.remove('hit'); gutEl.classList.remove('hit'); }, 1200);
    }

    document.body.addEventListener('click', e => {
      const a = e.target.closest('a.jump');
      if (a){ e.preventDefault(); const idx = Number(a.getAttribute('data-line')); jumpToLine(idx); }
    });

    // 미리보기 줄 더블클릭 편집 (단일 클릭은 선택/복사 용도로 유지)
    linesDiv.addEventListener('dblclick', (e) => {
      const pre = e.target.closest('pre');
      if (!pre || !pre.dataset.index) return;
      if (pre.isContentEditable) return;
      pre.contentEditable = 'true';
      pre.classList.add('editing');
      const idx = Number(pre.dataset.index);
      const original = lines[idx];
      // 선택/커서는 변경하지 않습니다.
      function commit(){
        pre.contentEditable = 'false';
        pre.classList.remove('editing');
        const v = pre.textContent ?? '';
        if (v !== original) { lines[idx] = v; dirty = true; runAnalyze(); }
      }
      function revert(){ pre.textContent = original; commit(); }
      pre.addEventListener('blur', commit, { once:true });
      pre.addEventListener('keydown', (ke)=>{
        if (ke.key==='Enter' && !ke.shiftKey){ ke.preventDefault(); pre.blur(); }
        else if (ke.key==='Escape'){ ke.preventDefault(); revert(); pre.blur(); }
      });
    });

    // 분석 로직
    function runAnalyze(){
      if (!lines.length) { alert('파일을 먼저 선택해 주십시오.'); return; }
      const countOdd = [];
      const hasJP = [];
      const considerEsc = !!ignoreEscaped.checked;
      const includeKanji = !!kanjiToo.checked;
      Array.from(gutter.children).forEach(el=>{ el.classList.remove('hit','hit-ja'); });
      Array.from(linesDiv.querySelectorAll('pre')).forEach(el=>{ el.classList.remove('hit','hit-ja'); });
      for (let i=0;i<lines.length;i++){
        const line = lines[i];
        const q = quoteCount(line, considerEsc);
        if (q === 1 || (q % 2 !== 0)) {
          countOdd.push({ idx: i+1, text: line });
          const lineEl = linesDiv.querySelectorAll('pre')[i];
          const gutEl = gutter.children[i+1];
          lineEl.classList.add('hit'); gutEl.classList.add('hit');
        }
        if (hasJapanese(line, includeKanji)) {
          hasJP.push({ idx: i+1, text: line });
          const lineEl = linesDiv.querySelectorAll('pre')[i];
          const gutEl = gutter.children[i+1];
          lineEl.classList.add('hit-ja'); gutEl.classList.add('hit-ja');
        }
      }
      totalLines.textContent = `총 줄: ${lines.length}`;
      oddQuotes.textContent = `따옴표 문제 줄: ${countOdd.length}`;
      jpLines.textContent = `일본어 포함 줄: ${hasJP.length}`;
      okMsg.style.display = (countOdd.length===0 && hasJP.length===0) ? 'inline-block' : 'none';
      tblQuotes.innerHTML = '';
      tblJP.innerHTML = '';
      for (const r of countOdd) addRow(tblQuotes, r.idx, r.text);
      for (const r of hasJP) addRow(tblJP, r.idx, r.text);
    }
    analyzeBtn.addEventListener('click', runAnalyze);

    // 결과표 셀 더블클릭 편집
    function beginCellEdit(tr){
      const link = tr.querySelector('a.jump');
      const idx = Number(link?.dataset.line || '0'); if (!idx) return;
      const cell = tr.children[1];
      const original = lines[idx-1] ?? '';
      const ta = document.createElement('textarea');
      ta.value = original; ta.style.width='100%'; ta.style.minHeight='64px';
      ta.style.background='#0b1220'; ta.style.color='#e5e7eb';
      ta.style.border='1px solid #334155'; ta.style.borderRadius='8px';
      ta.style.padding='8px 10px'; ta.spellcheck=false;
      const bar = document.createElement('div'); bar.style.marginTop='6px';
      const save = document.createElement('button'); save.textContent='저장'; save.className='btn'; save.style.marginRight='6px';
      const cancel = document.createElement('button'); cancel.textContent='취소'; cancel.className='btn';
      const wrap = document.createElement('div'); wrap.appendChild(ta); wrap.appendChild(bar); bar.appendChild(save); bar.appendChild(cancel);
      cell.dataset.prev = cell.innerHTML; cell.innerHTML=''; cell.appendChild(wrap);
      ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length);
      function commit(val){ lines[idx-1] = val; dirty = true; const pre = linesDiv.querySelectorAll('pre')[idx-1]; if (pre) pre.textContent = val; cell.innerHTML = `<span class="code">${esc(val)}</span>`; runAnalyze(); }
      function revert(){ cell.innerHTML = cell.dataset.prev || ''; }
      save.addEventListener('click', ()=> commit(ta.value));
      cancel.addEventListener('click', revert);
      ta.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='enter'){ e.preventDefault(); save.click(); } });
    }
    document.querySelector('#tblQuotes tbody').addEventListener('dblclick', (e)=>{
      const td = e.target.closest('td'); const tr = e.target.closest('tr'); if (!td||!tr) return; if (td.cellIndex===1) beginCellEdit(tr);
    });
    document.querySelector('#tblJP tbody').addEventListener('dblclick', (e)=>{
      const td = e.target.closest('td'); const tr = e.target.closest('tr'); if (!td||!tr) return; if (td.cellIndex===1) beginCellEdit(tr);
    });

    // 파일 다운로드 (다른 이름으로)
    function downloadFile(){
      if (!lines.length) { alert('저장할 내용이 없습니다. 파일을 먼저 불러오십시오.'); return; }
      const name = (fnameInput?.value?.trim()) || currentFilename || 'edited.sc';
      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); dirty=false; }, 0);
    }
    downloadBtn.addEventListener('click', downloadFile);
    fnameInput.addEventListener('input', ()=>{ const v = fnameInput.value.trim(); if (v) currentFilename = v; });

    // 단축키: Ctrl+S 저장
    window.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); downloadFile(); }
    });
  </script>
</body>
</html>